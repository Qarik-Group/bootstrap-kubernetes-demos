#!/bin/bash

# Deploys k-rail from master/HEAD

set -eu

cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

up() {
  (
    echo "Installing k-rails..."
    echo "--> downloading latest k-rail release..."
    cd $(mktemp -d)
    curl -sL https://api.github.com/repos/cruise-automation/k-rail/releases/latest | jq -r .tarball_url | xargs curl -L | tar xzf -
    cd cruise-automation*/
    echo "--> installing..."
    helm template --namespace k-rail deploy/helm | kubectl apply -n k-rail -f -
  )
}

down() {
  kubectl delete ns k-rail
  kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io k-rail
}

case "${1:-usage}" in
  up)
    shift
    up
    ;;

  down)
    shift
    down
    ;;

  *)
    ;;
esac


